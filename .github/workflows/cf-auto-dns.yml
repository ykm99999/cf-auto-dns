CF_IPS=(
  104.16.0.0
  104.17.0.0
  104.18.0.0
  104.19.0.0
  104.20.0.0
  104.21.0.0
  172.67.0.0
  162.159.0.0
)

BEST_IP=""
BEST_TIME=999999

echo "开始 Cloudflare 优选 IP（HTTPS 测速）..."

for ip in "${CF_IPS[@]}"; do
    TIME=$(curl -o /dev/null -s -w "%{time_connect}" --connect-timeout 2 https://$ip 2>/dev/null)
    if [[ $? -eq 0 ]]; then
        echo "IP: $ip 连接时间: $TIME 秒"
        COMP=$(echo "$TIME < $BEST_TIME" | bc)
        if [[ $COMP -eq 1 ]]; then
            BEST_TIME=$TIME
            BEST_IP=$ip
        fi
    else
        echo "IP: $ip 不可连接"
    fi
done

echo "最佳 IP: $BEST_IP"
echo "BEST_IP=$BEST_IP" >> $GITHUB_ENV

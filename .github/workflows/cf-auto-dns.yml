name: Cloudflare Auto Best IP

on:
  schedule:
    - cron: "0 */6 * * *"   # 每 6 小时自动运行
  workflow_dispatch:        # 手动触发

jobs:
  update-dns:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y jq bc

    - name: Generate best Cloudflare IP
      run: |
        CF_IPS=(
          104.16.0.0
          104.17.0.0
          104.18.0.0
          104.19.0.0
          104.20.0.0
          104.21.0.0
          172.67.0.0
          162.159.0.0
        )

        BEST_IP=""
        BEST_RTT=999999

        echo "开始 Cloudflare 优选 IP 探测..."

        for ip in "${CF_IPS[@]}"; do
            RTT=$(ping -c 1 -W 1 $ip 2>/dev/null | grep 'time=' | awk -F'time=' '{print $2}' | awk '{print $1}')
            if [[ -n "$RTT" ]]; then
                echo "IP: $ip 延迟: ${RTT}ms"
                if (( $(echo "$RTT < $BEST_RTT" | bc -l) )); then
                    BEST_RTT=$RTT
                    BEST_IP=$ip
                fi
            else
                echo "IP: $ip 不可达"
            fi
        done

        echo "最佳 IP: $BEST_IP"
        echo "BEST_IP=$BEST_IP" >> $GITHUB_ENV

    - name: Update Cloudflare DNS
      run: |
        echo "更新 DNS 到: $BEST_IP"

        RECORD_ID=$(curl -s -X GET \
          "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/dns_records?type=A&name=${{ secrets.DOMAIN }}" \
          -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
          -H "Content-Type: application/json" | jq -r '.result[0].id')

        curl -s -X PUT \
          "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/dns_records/$RECORD_ID" \
          -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data "{\"type\":\"A\",\"name\":\"${{ secrets.DOMAIN }}\",\"content\":\"$BEST_IP\",\"ttl\":120,\"proxied\":false}"

        echo "DNS 已更新为 $BEST_IP"
